<!DOCTYPE html>
<html lang="en">
    <head>
        <title>RSA Auth Tester - Logged in</title>
        <link rel="stylesheet" href="style.css"></link>
    </head>
    <body>
        <h1>Authentication passed!</h1>
        <br>
        And without even a single password request. (if you didn't encrypt your saved key for security, of course)
        <br>
        Your multi-user ID (aka username) is <label id="dexss">%username%</label>
        <hr>
        <a href="/logout">Log out</a>
        <br>
        <a href="/registerPubKey">Change the keys</a>
        <hr>
        Manage Imagination:
        <br>
        <button onclick="encryptKey()" id="key_encrypt">Encrypt or decrypt an Imagination saved key</button>
        <script src="/imagination.js"></script>
        <script>
            dexss.innerText = decodeURIComponent(dexss.innerHTML);
            let notifiedOfInsecure = false;
            setInterval(function() {
                if (!isSecureContext) {
                    key_encrypt.disabled = true;
                    if (!notifiedOfInsecure) {
                        notifiedOfInsecure = true;
                        alert("You are running in an insecure context (not HTTPS and not localhost). Please run in a secure context.");
                    }
                }
            });
            async function encryptKey() {
                let privk = (localStorage.getItem("privk") || "");
                let encryptMark = privk.startsWith("encrypted:");
                if (!privk) return alert("Private key not found.");
                if (encryptMark) {
                    if (confirm("The key is already encrypted. Would you like to decrypt the key?")) {
                        let password = prompt("Enter your passphrase, then press Enter:");
                        if (!password) return;
                        try {
                            localStorage.setItem("privk", await decryptAES(JSON.parse(privk.replace("encrypted:", "")), password));
                        } catch {
                            alert("Seems like your passphrase was not correct. Try again later.");
                        }
                    }
                } else {
                    let password = prompt("Enter a new passphrase, then press Enter:");
                    if (!password) return;
                    try {
                        localStorage.setItem("privk", "encrypted:" + JSON.stringify(await encryptAES(privk, password)));
                    } catch (e) {
                        console.log(e);
                        alert("Something went wrong!");
                    }
                }
            }
        </script>
    </body>
</html>